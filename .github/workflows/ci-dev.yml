name: Github CI - Development

on:
  push:
    branches: [ develop, master ]

jobs:
  setup-and-build:
    name: Setup and build
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ğŸ“ Check out the repository
        uses: actions/checkout@v4.1.1

      - name: ğŸ“¦ Cache Rust toolchain
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: rust-toolchain-

      - name: ğŸ› ï¸ Set up Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: rustfmt, clippy

      - name: âœ… Check with Clippy linter
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: -- -D warnings

      - name: ğŸ’„ Format code with Cargo formatter
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check

      - name: ğŸ¦€ Install Rust dependencies and build library
        uses: actions-rs/cargo@v1
        with:
          command: build

  integration-tests:
    name: Integration tests
    runs-on: ubuntu-latest
    needs: setup-and-build
    permissions:
      contents: read

    services:
      hello-world:
        image: hello-world

    steps:
      - name: ğŸ“ Check out the repository
        uses: actions/checkout@v4.1.1

      - name: ğŸ“¦ Cache Rust toolchain
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: rust-toolchain-

      - name: ğŸ› ï¸ Set up Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable

      - name: ğŸ§ª Run integration tests
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -- --test-threads=1